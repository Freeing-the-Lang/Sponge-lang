name: ğŸ” Ultra Matrix â€” DownConvert + UpRestore 3OS (Rust/NASM/Java/Scala/Haskell/Ruby/Go)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 6 * * *"

permissions:
  contents: write

jobs:
  ultra-matrix:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        repo: [
          "Freeing-the-Lang/Rust-like-Java",
          "Freeing-the-Lang/Rust-like-ruby",
          "Freeing-the-Lang/Rust-like-go",
          "Freeing-the-Lang/Haskell-like-rust",
          "Freeing-the-Lang/Scala-like-rust"
        ]

    steps:
      - uses: actions/checkout@v4

      - name: Install deps
        run: |
          if [ "${{ runner.os }}" = "Linux" ]; then
            sudo apt update && sudo apt install -y nasm cmake g++
          fi
          if [ "${{ runner.os }}" = "macOS" ]; then
            brew install cmake nasm
          fi

      - name: Build Spongelang
        run: |
          cmake -B build -S .
          cmake --build build --config Release

      # === ì›ë³¸ ë¦¬í¬ Release ë‹¤ìš´ë¡œë“œ ===
      - name: Get latest release of ${{ matrix.repo }}
        id: rel
        uses: pozetroninc/github-action-get-latest-release@v1
        with:
          repository: ${{ matrix.repo }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download asset
        run: |
          curl -L -o input.cpp "${{ steps.rel.outputs.assets_url }}"

      # ====== DOWNWARD: Rust / NASM ======
      - name: Convert â†’ Rust
        run: |
          ./build/spongelang --input input.cpp --output down_${{ matrix.repo##*/ }}_${{ runner.os }}.rs --mode rust

      - name: Convert â†’ NASM
        run: |
          ./build/spongelang --input input.cpp --output down_${{ matrix.repo##*/ }}_${{ runner.os }}.asm --mode nasm

      # ====== UPWARD RESTORE: Java / Scala / Haskell / Ruby / Go ======
      - name: Restore â†’ Java
        run: |
          ./build/spongelang --input input.cpp --output up_java_${{ matrix.repo##*/ }}_${{ runner.os }}.java --mode java

      - name: Restore â†’ Scala
        run: |
          ./build/spongelang --input input.cpp --output up_scala_${{ matrix.repo##*/ }}_${{ runner.os }}.scala --mode scala

      - name: Restore â†’ Haskell
        run: |
          ./build/spongelang --input input.cpp --output up_hs_${{ matrix.repo##*/ }}_${{ runner.os }}.hs --mode haskell

      - name: Restore â†’ Ruby
        run: |
          ./build/spongelang --input input.cpp --output up_rb_${{ matrix.repo##*/ }}_${{ runner.os }}.rb --mode ruby

      - name: Restore â†’ Go
        run: |
          ./build/spongelang --input input.cpp --output up_go_${{ matrix.repo##*/ }}_${{ runner.os }}.go --mode go

      # ====== ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ ======
      - uses: actions/upload-artifact@v4
        with:
          name: converted-${{ matrix.repo##*/ }}-${{ runner.os }}
          path: |
            down_${{ matrix.repo##*/ }}_${{ runner.os }}.rs
            down_${{ matrix.repo##*/ }}_${{ runner.os }}.asm
            up_java_${{ matrix.repo##*/ }}_${{ runner.os }}.java
            up_scala_${{ matrix.repo##*/ }}_${{ runner.os }}.scala
            up_hs_${{ matrix.repo##*/ }}_${{ runner.os }}.hs
            up_rb_${{ matrix.repo##*/ }}_${{ runner.os }}.rb
            up_go_${{ matrix.repo##*/ }}_${{ runner.os }}.go

      # ====== ì›ë³¸ ë¦¬í¬ë¡œ ë³µì› ë¦´ë¦¬ì¦ˆ ======
      - uses: softprops/action-gh-release@v1
        with:
          tag_name: "spongelang-ultra-v1"
          name: "Downconvert + UpRestore (Spongelang Ultra Matrix)"
          repository: ${{ matrix.repo }}
          files: |
            down_${{ matrix.repo##*/ }}_${{ runner.os }}.rs
            down_${{ matrix.repo##*/ }}_${{ runner.os }}.asm
            up_java_${{ matrix.repo##*/ }}_${{ runner.os }}.java
            up_scala_${{ matrix.repo##*/ }}_${{ runner.os }}.scala
            up_hs_${{ matrix.repo##*/ }}_${{ runner.os }}.hs
            up_rb_${{ matrix.repo##*/ }}_${{ runner.os }}.rb
            up_go_${{ matrix.repo##*/ }}_${{ runner.os }}.go
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
