name: üåê META-ULTRA ‚Äî Full Auto Scan + 3OS Transform + Auto Release (Freeing-the-Lang)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  meta-ultra:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (for Spongelang Engine)
        uses: actions/checkout@v4

      - name: Scan Freeing-the-Lang Organization (No-C repos)
        id: scan
        uses: actions/github-script@v7
        with:
          script: |
            const org = "Freeing-the-Lang";

            let repos = [];
            let page = 1;

            while (true) {
              const res = await github.rest.repos.listForOrg({
                org,
                per_page: 100,
                page
              });

              if (!res.data.length) break;

              for (const repo of res.data) {
                const name = repo.name.toLowerCase();

                if (name.includes("c-")) continue;
                if (name.includes("c23")) continue;
                if (name.includes("tardigrada")) continue;
                if (name.includes("pure-c")) continue;

                repos.push(repo.full_name);
              }

              page++;
            }

            core.setOutput("list", JSON.stringify(repos));
            console.log("FOUND REPOS:", repos);

      - name: Install deps
        shell: bash
        run: |
          sudo apt update && sudo apt install -y cmake g++ nasm

      - name: Build Spongelang Engine
        shell: bash
        run: |
          cmake -B build -S .
          cmake --build build --config Release


      # ======================================================
      # LOOP: Ultra-Matrix inside a single workflow
      # (Ïù¥Í≤å ÌïµÏã¨: meta + ultra-matrix ÌÜµÌï© Íµ¨Ï°∞)
      # ======================================================

      - name: Run Ultra-Matrix Transform for Each Repo (3OS)
        id: matrixloop
        uses: actions/github-script@v7
        with:
          script: |
            const repos = JSON.parse("${{ steps.scan.outputs.list }}");
            const owner = context.repo.owner;
            const currentRepo = context.repo.repo;

            // 3OS Îß§Ìä∏Î¶≠Ïä§ Ï†ïÏùò
            const OSes = ["ubuntu-latest", "macos-latest", "windows-latest"];

            return { repos, OSes };
        result-encoding: string


      - name: Execute ULTRA for each repo + each OS
        shell: bash
        run: |
          repos=${{ steps.matrixloop.outputs.result }}
          repos=$(echo "$repos" | jq -r '.repos[]')
          OSes=$(echo "${{ steps.matrixloop.outputs.result }}" | jq -r '.OSes[]')

          echo "=== Running Ultra Pipeline ==="
          for repo in $repos; do
            for os in $OSes; do
              echo "‚ñ∂ Executing Ultra for: $repo @ $os"

              gh api \
                -X POST \
                repos/${{ github.repository }}/actions/workflows/ultra-exec.yml/dispatches \
                -F ref=main \
                -F inputs[target_repo]=$repo \
                -F inputs[target_os]=$os
            done
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
