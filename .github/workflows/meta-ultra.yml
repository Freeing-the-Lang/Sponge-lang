name: "SpongeLang — FULL AUTO 4OS + META + ProofLedger + SHA256 Release"

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: write

env:
  BUILD_TYPE: Release

# =====================================================================
# 1) AUTO TAG
# =====================================================================
jobs:
  auto-tag:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.tag-step.outputs.tag }}

    steps:
      - uses: actions/checkout@v4

      - name: Generate timestamp tag
        id: tag-step
        run: |
          TAG="v$(date +'%Y%m%d%H%M%S')"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Push tag
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git tag ${{ steps.tag-step.outputs.tag }}
          git push origin ${{ steps.tag-step.outputs.tag }}



# =====================================================================
# 2) 4OS BUILD
# =====================================================================
  build:
    needs: auto-tag
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, macos-13, windows-latest]

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      # ------------------------------------------------------------
      # Setup CMake (Official)
      # ------------------------------------------------------------
      - name: Install CMake
        uses: jwlawson/actions-setup-cmake@v1

      - name: Configure
        shell: bash
        run: cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=${BUILD_TYPE}

      - name: Build
        shell: bash
        run: cmake --build build --config ${BUILD_TYPE}

      - name: Install
        shell: bash
        run: cmake --install build --config ${BUILD_TYPE}


      # ------------------------------------------------------------
      # PYTHON venv (Windows 포함 완전 호환)
      # ------------------------------------------------------------
      - name: Setup Python & venv
        run: |
          python -m venv venv

        shell: bash

      - name: Activate venv & install deps (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          source venv/bin/activate
          pip install pyyaml

      - name: Activate venv & install deps (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          ./venv/Scripts/Activate.ps1
          pip install pyyaml


      # ------------------------------------------------------------
      # META PACK GENERATION
      # ------------------------------------------------------------
      - name: Generate META Pack (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          source venv/bin/activate
          python3 tools/generate_meta.py
          mkdir -p build/meta_packs
          cp -r packs/* build/meta_packs/ 2>/dev/null || true

      - name: Generate META Pack (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          ./venv/Scripts/Activate.ps1
          python tools/generate_meta.py
          mkdir build/meta_packs -ea SilentlyContinue
          Copy-Item -Path packs\* -Destination build/meta_packs -Recurse -ErrorAction SilentlyContinue


      # ------------------------------------------------------------
      # COLLECT BINARIES (4OS AUTO)
      # ------------------------------------------------------------
      - name: Collect Binaries (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p collected_bin

          # Possible dirs
          for DIR in build/bin build/Release build; do
            if [ -d "$DIR" ]; then
              cp -r $DIR/* collected_bin/ 2>/dev/null || true
            fi
          done

          # Executables only
          find build -maxdepth 4 -type f -perm -u+x -print0 \
            | while IFS= read -r -d '' f; do cp "$f" collected_bin/ || true; done

          echo "Collected binaries:"
          ls -al collected_bin || true

      - name: Collect Binaries (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path collected_bin | Out-Null

          # Copy typical build dirs
          foreach ($d in @("build/bin","build/Release","build")) {
            if (Test-Path $d) {
              Copy-Item "$d\*" collected_bin -Recurse -ErrorAction SilentlyContinue
            }
          }

          # Find .exe / .dll
          Get-ChildItem -Path build -Recurse -Include *.exe,*.dll |
            ForEach-Object { Copy-Item $_.FullName collected_bin -ErrorAction SilentlyContinue }

          Write-Host "Collected binaries:"
          Get-ChildItem collected_bin


      # ------------------------------------------------------------
      # OS NORMALIZATION
      # ------------------------------------------------------------
      - name: Normalize OS Name
        id: osname
        shell: bash
        run: |
          case "${{ matrix.os }}" in
            ubuntu*)      echo "osn=linux"       >> $GITHUB_OUTPUT ;;
            macos-latest) echo "osn=macos-arm"   >> $GITHUB_OUTPUT ;;
            macos-13)     echo "osn=macos-intel" >> $GITHUB_OUTPUT ;;
            windows*)     echo "osn=windows"     >> $GITHUB_OUTPUT ;;
          esac


      # ------------------------------------------------------------
      # Package OS Build
      # ------------------------------------------------------------
      - name: Package Build
        shell: bash
        run: |
          mkdir -p package/${{ steps.osname.outputs.osn }}
          cp -r collected_bin package/${{ steps.osname.outputs.osn }}/
          cp -r build/meta_packs package/${{ steps.osname.outputs.osn }}/ 2>/dev/null || true

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: spongelang-${{ steps.osname.outputs.osn }}
          path: package/${{ steps.osname.outputs.osn }}
          if-no-files-found: warn



# =====================================================================
# 3) RELEASE + SHA256 + PROOFLEDGER
# =====================================================================
  auto-release:
    needs: [auto-tag, build]
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          path: release-tmp


      # ------------------------------------------------------------
      # ORGANIZE BY OS
      # ------------------------------------------------------------
      - name: Organize Release Files
        shell: bash
        run: |
          mkdir -p release/linux release/macos-arm release/macos-intel release/windows

          cp -r release-tmp/spongelang-linux/*        release/linux/       2>/dev/null || true
          cp -r release-tmp/spongelang-macos-arm/*    release/macos-arm/   2>/dev/null || true
          cp -r release-tmp/spongelang-macos-intel/*  release/macos-intel/ 2>/dev/null || true
          cp -r release-tmp/spongelang-windows/*      release/windows/     2>/dev/null || true


      # ------------------------------------------------------------
      # ZIP BY OS
      # ------------------------------------------------------------
      - name: ZIP Builds
        shell: bash
        run: |
          cd release
          zip -r linux.zip linux
          zip -r macos-arm.zip macos-arm
          zip -r macos-intel.zip macos-intel
          zip -r windows.zip windows


      # ------------------------------------------------------------
      # SHA256 PACK
      # ------------------------------------------------------------
      - name: Generate SHA256
        shell: bash
        run: |
          mkdir -p release/SHA256
          cd release

          for f in linux.zip macos-arm.zip macos-intel.zip windows.zip; do
            sha256sum "$f" > "SHA256/${f}.sha256"
          done


      # ------------------------------------------------------------
      # PROOFLEDGER
      # ------------------------------------------------------------
      - name: Generate ProofLedger
        shell: bash
        run: |
          cd release
          {
            echo "SpongeLang ProofLedger"
            echo "Timestamp: $(date -u)"
            echo "Tag: ${{ needs.auto-tag.outputs.tag }}"
            echo "Commit: $(git rev-parse HEAD)"
            echo ""
            echo "SHA256 Proof:"
            cat SHA256/linux.zip.sha256
            cat SHA256/macos-arm.zip.sha256
            cat SHA256/macos-intel.zip.sha256
            cat SHA256/windows.zip.sha256
            echo ""
            echo "Contributor:"
            echo "- GitHub Actions Bot"
          } > proofledger.txt


      # ------------------------------------------------------------
      # CREATE RELEASE
      # ------------------------------------------------------------
      - name: Publish Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.auto-tag.outputs.tag }}
          name: "SpongeLang — FULL AUTO META + ProofLedger + SHA256 — ${{ needs.auto-tag.outputs.tag }}"
          body: |
            ## SpongeLang FULL AUTO Release
            Includes:
            - Linux / macOS ARM / macOS Intel / Windows
            - META Packs
            - SHA256 Proof Packs
            - ProofLedger
            - Auto Timestamp Tag
          files: |
            release/linux.zip
            release/macos-arm.zip
            release/macos-intel.zip
            release/windows.zip
            release/SHA256/*.sha256
            release/proofledger.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
