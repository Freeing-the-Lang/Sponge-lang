name: ðŸ” Ultra Matrix â€” DownConvert + UpRestore (3OS, No-C)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  ultra-matrix:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        repo: [
          "Freeing-the-Lang/Rust-like-Java",
          "Freeing-the-Lang/Rust-like-ruby",
          "Freeing-the-Lang/Rust-like-go",
          "Freeing-the-Lang/Haskell-like-rust",
          "Freeing-the-Lang/Scala-like-rust"
        ]

    steps:
      - name: Checkout Spongelang Engine
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          if [ "${{ runner.os }}" = "Linux" ]; then
            sudo apt update && sudo apt install -y cmake g++ nasm
          fi
          if [ "${{ runner.os }}" = "macOS" ]; then
            brew install cmake nasm
          fi

      - name: Build Spongelang
        run: |
          cmake -B build -S .
          cmake --build build --config Release


      # === ìµœì‹  ë¦´ë¦¬ì¦ˆ asset URL ê°€ì ¸ì˜¤ê¸° (official) ===
      - name: Get latest release asset URL
        id: getasset
        uses: actions/github-script@v7
        with:
          script: |
            const repo = "${{ matrix.repo }}";
            const [owner, name] = repo.split("/");
            const rel = await github.rest.repos.getLatestRelease({
              owner,
              repo: name
            });

            if (!rel.data.assets.length) {
              core.setFailed("âŒ No release assets found.");
              return;
            }

            const asset = rel.data.assets[0];
            core.setOutput("url", asset.browser_download_url);


      - name: Download asset
        run: |
          curl -L -o input.cpp "${{ steps.getasset.outputs.url }}"

      # === repo_name ì¶”ì¶œ ===
      - name: Extract repo name
        id: namefix
        shell: bash
        run: |
          repo_name=$(basename "${{ matrix.repo }}")
          echo "repo_name=$repo_name" >> $GITHUB_OUTPUT


      # ===== Downward: Rust / NASM =====
      - name: Convert â†’ Rust
        run: |
          ./build/spongelang --input input.cpp --output down_${{ steps.namefix.outputs.repo_name }}_${{ runner.os }}.rs --mode rust

      - name: Convert â†’ NASM
        run: |
          ./build/spongelang --input input.cpp --output down_${{ steps.namefix.outputs.repo_name }}_${{ runner.os }}.asm --mode nasm


      # ===== Upward Restore =====
      - name: Restore â†’ Java
        run: |
          ./build/spongelang --input input.cpp --output up_java_${{ steps.namefix.outputs.repo_name }}_${{ runner.os }}.java --mode java

      - name: Restore â†’ Scala
        run: |
          ./build/spongelang --input input.cpp --output up_scala_${{ steps.namefix.outputs.repo_name }}_${{ runner.os }}.scala --mode scala

      - name: Restore â†’ Haskell
        run: |
          ./build/spongelang --input input.cpp --output up_hs_${{ steps.namefix.outputs.repo_name }}_${{ runner.os }}.hs --mode haskell

      - name: Restore â†’ Ruby
        run: |
          ./build/spongelang --input input.cpp --output up_rb_${{ steps.namefix.outputs.repo_name }}_${{ runner.os }}.rb --mode ruby

      - name: Restore â†’ Go
        run: |
          ./build/spongelang --input input.cpp --output up_go_${{ steps.namefix.outputs.repo_name }}_${{ runner.os }}.go --mode go


      # ===== ì•„í‹°íŒ©íŠ¸ =====
      - uses: actions/upload-artifact@v4
        with:
          name: output-${{ steps.namefix.outputs.repo_name }}-${{ runner.os }}
          path: |
            down_${{ steps.namefix.outputs.repo_name }}_${{ runner.os }}.rs
            down_${{ steps.namefix.outputs.repo_name }}_${{ runner.os }}.asm
            up_java_${{ steps.namefix.outputs.repo_name }}_${{ runner.os }}.java
            up_scala_${{ steps.namefix.outputs.repo_name }}_${{ runner.os }}.scala
            up_hs_${{ steps.namefix.outputs.repo_name }}_${{ runner.os }}.hs
            up_rb_${{ steps.namefix.outputs.repo_name }}_${{ runner.os }}.rb
            up_go_${{ steps.namefix.outputs.repo_name }}_${{ runner.os }}.go
