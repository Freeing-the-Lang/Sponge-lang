name: ðŸ” ULTRA-EXEC â€” Per Repo / Per OS Executor

on:
  workflow_dispatch:
    inputs:
      target_repo:
        description: "Target repository full name"
        required: true
      target_os:
        description: "Target OS"
        required: true

permissions:
  contents: write

jobs:
  ultra:
    runs-on: ${{ inputs.target_os }}

    steps:
      - name: Install deps
        shell: bash
        run: |
          if [ "${{ inputs.target_os }}" = "ubuntu-latest" ]; then
            sudo apt update && sudo apt install -y cmake g++ nasm
          fi
          if [ "${{ inputs.target_os }}" = "macos-latest" ]; then
            brew install cmake nasm
          fi

      - name: Checkout Spongelang
        uses: actions/checkout@v4

      - name: Build Engine
        shell: bash
        run: |
          cmake -B build -S .
          cmake --build build --config Release


      # === Fetch latest release asset ===
      - name: Fetch latest release asset
        id: rel
        uses: actions/github-script@v7
        with:
          script: |
            const full = "${{ github.event.inputs.target_repo }}";
            const [owner, repo] = full.split("/");

            const release = await github.rest.repos.getLatestRelease({ owner, repo });
            if (!release.data.assets.length) core.setFailed("No asset");

            core.setOutput("url", release.data.assets[0].browser_download_url);

      - name: Download asset
        shell: bash
        run: curl -L -o input.cpp "${{ steps.rel.outputs.url }}"


      # === Extract repo name ===
      - name: Extract repo name
        id: rn
        shell: bash
        run: |
          echo "repo=$(basename '${{ inputs.target_repo }}')" >> $GITHUB_OUTPUT


      # === Downconvert ===
      - name: To Rust
        shell: bash
        run: ./build/spongelang --input input.cpp --output down_${{ steps.rn.outputs.repo }}.rs --mode rust

      - name: To NASM
        shell: bash
        run: ./build/spongelang --input input.cpp --output down_${{ steps.rn.outputs.repo }}.asm --mode nasm


      # === UpRestore ===
      - name: To Java
        shell: bash
        run: ./build/spongelang --input input.cpp --output up_java_${{ steps.rn.outputs.repo }}.java --mode java

      - name: To Scala
        shell: bash
        run: ./build/spongelang --input input.cpp --output up_scala_${{ steps.rn.outputs.repo }}.scala --mode scala

      - name: To Haskell
        shell: bash
        run: ./build/spongelang --input input.cpp --output up_hs_${{ steps.rn.outputs.repo }}.hs --mode haskell

      - name: To Ruby
        shell: bash
        run: ./build/spongelang --input input.cpp --output up_rb_${{ steps.rn.outputs.repo }}.rb --mode ruby

      - name: To Go
        shell: bash
        run: ./build/spongelang --input input.cpp --output up_go_${{ steps.rn.outputs.repo }}.go --mode go


      # === Auto Tagging ===
      - name: Determine next auto-tag
        id: autotag
        uses: actions/github-script@v7
        with:
          script: |
            const full = "${{ inputs.target_repo }}";
            const [owner, repo] = full.split("/");

            const rel = await github.rest.repos.listReleases({
              owner, repo, per_page: 100
            });

            const auto = rel.data.filter(r => r.tag_name.startsWith("spongelang-auto-v"));

            if (!auto.length) {
              core.setOutput("tag", "spongelang-auto-v1");
              return;
            }

            const nums = auto.map(r => parseInt(r.tag_name.replace("spongelang-auto-v","")));
            const next = Math.max(...nums) + 1;

            core.setOutput("tag", `spongelang-auto-v${next}`);


      # === Upload to Release ===
      - name: Upload to Release
        uses: softprops/action-gh-release@v1
        with:
          repository: ${{ inputs.target_repo }}
          tag_name: ${{ steps.autotag.outputs.tag }}
          name: "Auto Transform â€” ${{ steps.autotag.outputs.tag }}"
          files: |
            down_${{ steps.rn.outputs.repo }}.rs
            down_${{ steps.rn.outputs.repo }}.asm
            up_java_${{ steps.rn.outputs.repo }}.java
            up_scala_${{ steps.rn.outputs.repo }}.scala
            up_hs_${{ steps.rn.outputs.repo }}.hs
            up_rb_${{ steps.rn.outputs.repo }}.rb
            up_go_${{ steps.rn.outputs.repo }}.go
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      # === Cleanup old auto-tags ===
      - name: Cleanup old auto-tags
        uses: actions/github-script@v7
        with:
          script: |
            const full = "${{ inputs.target_repo }}";
            const [owner, repo] = full.split("/");

            const rels = await github.rest.repos.listReleases({
              owner, repo, per_page: 100
            });

            const auto = rels.data
              .filter(r => r.tag_name.startsWith("spongelang-auto-v"))
              .sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

            const deleteList = auto.slice(10);

            for (const r of deleteList) {
              console.log("Deleting old:", r.tag_name);

              await github.rest.repos.deleteRelease({
                owner, repo,
                release_id: r.id
              });

              await github.rest.git.deleteRef({
                owner, repo,
                ref: `tags/${r.tag_name}`
              });
            }
