name: üåê META-ULTRA ‚Äî Full Auto Scan + 3OS Transform + Auto Release (Freeing-the-Lang)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  meta-ultra:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (for Spongelang Engine)
        uses: actions/checkout@v4

      - name: Scan Freeing-the-Lang Organization (No-C repos)
        id: scan
        uses: actions/github-script@v7
        with:
          script: |
            const org = "Freeing-the-Lang";

            let repos = [];
            let page = 1;

            while (true) {
              const res = await github.rest.repos.listForOrg({
                org,
                per_page: 100,
                page
              });

              if (!res.data.length) break;

              for (const repo of res.data) {
                const n = repo.name.toLowerCase();

                if (n.includes("c-")) continue;
                if (n.includes("c23")) continue;
                if (n.includes("tardigrada")) continue;
                if (n.includes("pure-c")) continue;

                repos.push(repo.full_name);
              }

              page++;
            }

            core.setOutput("repos", JSON.stringify(repos));
            console.log("FOUND REPOS:", repos);


      - name: Install deps
        shell: bash
        run: |
          sudo apt update && sudo apt install -y cmake g++ nasm jq


      - name: Build Spongelang Engine
        shell: bash
        run: |
          cmake -B build -S .
          cmake --build build --config Release


      # ======================================================
      # Create 3OS + Repo list outputs
      # ======================================================

      - name: Prepare Matrix Data (repos + OS list)
        id: matrixloop
        uses: actions/github-script@v7
        with:
          script: |
            const repos = JSON.parse(`${{ steps.scan.outputs.repos }}`);
            const OSes = ["ubuntu-latest", "macos-latest", "windows-latest"];

            core.setOutput("repos", JSON.stringify(repos));
            core.setOutput("oses",  JSON.stringify(OSes));

            console.log("Repos:", repos);
            console.log("OSes:", OSes);


      # ======================================================
      # Dispatch ultra-exec.yml for each repo √ó OS
      # ======================================================

      - name: Execute ULTRA for each repo + OS
        shell: bash
        run: |
          repos=$(echo '${{ steps.matrixloop.outputs.repos }}' | jq -r '.[]')
          OSes=$(echo '${{ steps.matrixloop.outputs.oses }}'   | jq -r '.[]')

          echo "=== Running Ultra Pipeline ==="
          for repo in $repos; do
            for os in $OSes; do
              echo "‚ñ∂ Dispatch Ultra-Exec: $repo @ $os"

              gh api \
                -X POST \
                repos/${{ github.repository }}/actions/workflows/ultra-exec.yml/dispatches \
                -F ref=main \
                -F inputs[target_repo]=$repo \
                -F inputs[target_os]=$os
            done
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
