name: ðŸ” Single-Repo META-ULTRA â€” 3OS Transform + Auto Release

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  ultra:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        shell: bash
        run: |
          if [ "${{ runner.os }}" = "Linux" ]; then
            sudo apt update && sudo apt install -y cmake g++ nasm jq
          fi
          if [ "${{ runner.os }}" = "macOS" ]; then
            brew install cmake nasm jq
          fi

      - name: Build Spongelang Engine
        shell: bash
        run: |
          cmake -B build -S .
          cmake --build build --config Release

      # ==========================================
      # Fetch this repo's latest release asset
      # ==========================================
      - name: Fetch Latest Release Asset
        id: rel
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const r = await github.rest.repos.getLatestRelease({ owner, repo });
            if (!r.data.assets.length) core.setFailed("âŒ No release asset found.");

            core.setOutput("url", r.data.assets[0].browser_download_url);
            core.setOutput("tag", r.data.tag_name);

      - name: Download Release Asset
        run: curl -L -o input.cpp "${{ steps.rel.outputs.url }}"

      # ==========================================
      # DOWN â†’ Rust / NASM
      # ==========================================
      - name: Downconvert â†’ Rust
        run: ./build/spongelang --input input.cpp --output out_rust_${{ matrix.os }}.rs --mode rust

      - name: Downconvert â†’ NASM
        run: ./build/spongelang --input input.cpp --output out_nasm_${{ matrix.os }}.asm --mode nasm

      # ==========================================
      # UP RESTORE â†’ Java / Scala / Haskell / Ruby / Go
      # ==========================================
      - name: Restore â†’ Java
        run: ./build/spongelang --input input.cpp --output up_java_${{ matrix.os }}.java --mode java

      - name: Restore â†’ Scala
        run: ./build/spongelang --input input.cpp --output up_scala_${{ matrix.os }}.scala --mode scala

      - name: Restore â†’ Haskell
        run: ./build/spongelang --input input.cpp --output up_hs_${{ matrix.os }}.hs --mode haskell

      - name: Restore â†’ Ruby
        run: ./build/spongelang --input input.cpp --output up_rb_${{ matrix.os }}.rb --mode ruby

      - name: Restore â†’ Go
        run: ./build/spongelang --input input.cpp --output up_go_${{ matrix.os }}.go --mode go

      # ==========================================
      # Auto Increment Release Tag
      # ==========================================
      - name: Auto Tag
        id: autotag
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const rels = await github.rest.repos.listReleases({ owner, repo });
            const auto = rels.data.filter(r => r.tag_name.startsWith("spongelang-auto-v"));

            if (!auto.length) return core.setOutput("tag", "spongelang-auto-v1");

            const nums = auto.map(r => parseInt(r.tag_name.replace("spongelang-auto-v","")));
            const next = Math.max(...nums) + 1;

            core.setOutput("tag", `spongelang-auto-v${next}`);

      # ==========================================
      # Upload to Release
      # ==========================================
      - name: Upload Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.autotag.outputs.tag }}
          name: "Auto Transform â€” ${{ steps.autotag.outputs.tag }}"
          files: |
            out_rust_${{ matrix.os }}.rs
            out_nasm_${{ matrix.os }}.asm
            up_java_${{ matrix.os }}.java
            up_scala_${{ matrix.os }}.scala
            up_hs_${{ matrix.os }}.hs
            up_rb_${{ matrix.os }}.rb
            up_go_${{ matrix.os }}.go
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==========================================
      # Cleanup old auto-v tags
      # ==========================================
      - name: Cleanup Old Auto-Tags
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const rels = await github.rest.repos.listReleases({ owner, repo });

            const auto = rels.data
              .filter(r => r.tag_name.startsWith("spongelang-auto-v"))
              .sort((a,b) => new Date(b.created_at) - new Date(a.created_at));

            const del = auto.slice(10);

            for (const r of del) {
              await github.rest.repos.deleteRelease({
                owner, repo, release_id: r.id
              });
              await github.rest.git.deleteRef({
                owner, repo, ref: `tags/${r.tag_name}`
              });
            }
